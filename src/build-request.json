{
  "kind": "build_request",
  "title": "Fix user not found error when adding phone numbers to existing accounts",
  "projectName": "Game Vault",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-90",
      "text": "Update the backend savePhoneNumber endpoint to check if a user profile already exists for the authenticated principal before attempting to create a new user record",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Fix the phone number adding it says user not found when it's ment to add a phone number to the existing account"
        ]
      },
      "acceptanceCriteria": [
        "The savePhoneNumber endpoint queries for an existing user profile using the caller's principal",
        "If a profile exists, the endpoint updates the phoneNumber field instead of creating a new user",
        "If no profile exists, the endpoint creates a new user with the phone number",
        "The endpoint returns success status after updating or creating the user record"
      ]
    },
    {
      "id": "REQ-91",
      "text": "Add validation in the backend savePhoneNumber endpoint to ensure phone numbers are unique across all users when updating existing accounts",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "All users should be able to add phone numbers to their existing accounts"
        ]
      },
      "acceptanceCriteria": [
        "Before updating a user's phone number, check if another user already has that phone number",
        "Return a descriptive error if the phone number is already in use by a different user",
        "Allow users to update their own phone number to the same value without error"
      ]
    },
    {
      "id": "REQ-92",
      "text": "Add user-facing error messages in the PhoneNumberSetup component to clearly display backend errors when phone number saving fails",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "I'll add clear error messages to help them understand what went wrong"
        ]
      },
      "acceptanceCriteria": [
        "Display specific error messages for 'user not found' errors",
        "Display specific error messages for 'phone number already in use' errors",
        "Show a generic error message for unexpected errors",
        "Error messages are displayed prominently in the PhoneNumberSetup dialog",
        "Users can retry phone number submission after seeing error messages"
      ]
    },
    {
      "id": "REQ-93",
      "text": "Verify the admin panel phone number addition functionality properly handles existing users and displays appropriate errors",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Admin phone number addition in the admin panel could also have this same issue"
        ]
      },
      "acceptanceCriteria": [
        "When admins add phone numbers to the whitelist through PaymentConfigForm, the backend properly validates the phone number exists in user records",
        "If the phone number doesn't belong to any existing user, display a clear error message",
        "The admin panel shows success confirmation when phone numbers are successfully added to the whitelist"
      ]
    }
  ],
  "constraints": [
    "Maintain the existing single-actor backend architecture",
    "Preserve phone number validation rules: numeric only, no + prefix, worldwide format support",
    "Do not modify the PhoneNumberSetup component structure or required field enforcement",
    "Keep the dual whitelist system (username and phone number) unchanged"
  ],
  "nonGoals": [
    "Adding phone number verification via SMS or email",
    "Implementing phone number formatting or country code detection",
    "Creating a separate admin interface for managing user phone numbers",
    "Adding bulk phone number import functionality"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}